<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Vault â€¢ Personal Media Storage</title>
  <style>
    .glass { background: rgba(17, 24, 39, 0.72); backdrop-filter: blur(10px); }
    .ring-soft { box-shadow: 0 0 0 1px rgba(148,163,184,.14); }

    .select-ui {
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148,163,184,.14);
      color: rgba(226,232,240,1);
    }
    .select-ui:focus { outline: none; background: rgba(15, 23, 42, 0.75); box-shadow: 0 0 0 1px rgba(99,102,241,.35); }
    select option { background: #0b1220; color: #e2e8f0; }

    /* Hide scrollbar (desktop modal form) */
    @media (min-width: 1024px) {
      .hide-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
      .hide-scrollbar::-webkit-scrollbar { width: 0; height: 0; }
    }

    button:disabled { opacity: .45; cursor: not-allowed; }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="relative">
  <!-- Background accents -->
  <div class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute left-[-120px] top-[-120px] h-[360px] w-[360px] rounded-full bg-indigo-600/20 blur-3xl"></div>
    <div class="absolute right-[-140px] top-[180px] h-[420px] w-[420px] rounded-full bg-cyan-500/10 blur-3xl"></div>
    <div class="absolute bottom-[-160px] left-[20%] h-[520px] w-[520px] rounded-full bg-fuchsia-500/10 blur-3xl"></div>
    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,rgba(56,189,248,0.08),transparent_55%),radial-gradient(ellipse_at_bottom,rgba(99,102,241,0.08),transparent_55%)]"></div>
  </div>

  <!-- Mobile sidebar toggle (CSS-only, no JS) -->
  <input id="navToggle" type="checkbox" class="peer hidden" />
  <input id="detailsToggle" type="checkbox" class="peer/details hidden" />

  <!-- Hidden file input (for Import) -->
  <input id="importFile" type="file" accept=".json,application/json" class="hidden" />

  <!-- Mobile top bar -->
  <div class="mx-auto w-full max-w-[1440px] px-4 pt-4 md:hidden">
    <div class="glass ring-soft rounded-2xl border border-white/5 p-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="grid h-9 w-9 place-items-center rounded-xl bg-indigo-500/15 ring-soft">
          <span class="text-indigo-300 font-semibold">V</span>
        </div>
        <div>
          <div class="text-sm font-semibold">Vault</div>
          <div class="text-[11px] text-slate-400">Personal Storage Library</div>
        </div>
      </div>

      <label for="navToggle"
        class="cursor-pointer rounded-xl bg-white/5 px-3 py-2 text-xs text-slate-200 ring-soft hover:bg-white/10">
        Menu
      </label>
    </div>
  </div>

  <!-- Mobile backdrop (tap to close) -->
  <label for="navToggle"
    class="fixed inset-0 z-40 hidden bg-black/60 peer-checked:block md:hidden"></label>
  <label for="detailsToggle"
    class="fixed inset-0 z-40 hidden bg-black/60 peer-checked/details:block lg:hidden"></label>

<!-- Mobile Sidebar Drawer -->
    <aside class="fixed left-0 top-0 z-50 h-full w-[280px] shrink-0 -translate-x-full overflow-y-auto p-4 transition-transform duration-200 peer-checked:translate-x-0 md:hidden">
      <div class="glass ring-soft rounded-2xl border border-white/5 p-4">
        <!-- Brand -->
        <div class="flex items-center gap-3">
          <div class="grid h-10 w-10 place-items-center rounded-xl bg-indigo-500/15 ring-soft">
            <span class="text-indigo-300 font-semibold">V</span>
          </div>
          <div>
            <div class="text-base font-semibold">Vault</div>
            <div class="text-xs text-slate-400">Personal Storage Library</div>
          </div>
        </div>

        <div class="mt-3 md:hidden">
          <label for="navToggle"
            class="inline-flex cursor-pointer rounded-xl bg-white/5 px-3 py-2 text-xs text-slate-200 ring-soft hover:bg-white/10">
            Close
          </label>
        </div>

        <!-- Quick actions -->
        <div class="mt-5 grid grid-cols-2 gap-2">
          <button id="btnAddMobile"
            class="rounded-xl bg-indigo-500/15 px-3 py-2 text-sm font-medium text-indigo-200 ring-soft hover:bg-indigo-500/20">
            + Add
          </button>
          <button id="btnImportMobile"
            class="rounded-xl bg-white/5 px-3 py-2 text-sm font-medium text-slate-200 ring-soft hover:bg-white/10">
            Import
          </button>
        </div>

        <div class="mt-2 grid grid-cols-2 gap-2">
          <button id="btnExportMobile"
            class="rounded-xl bg-white/5 px-3 py-2 text-sm font-medium text-slate-200 ring-soft hover:bg-white/10">
            Export
          </button>
          <button id="btnResetMobile"
            class="rounded-xl bg-rose-500/15 px-3 py-2 text-sm font-medium text-rose-200 ring-soft hover:bg-rose-500/20">
            Reset
          </button>
        </div>

        <!-- Nav (UI only for now) -->
        <div class="mt-6 space-y-1">
          <div class="text-xs font-semibold text-slate-400">LIBRARY</div>
          <a class="flex items-center justify-between rounded-xl bg-white/5 px-3 py-2 ring-soft hover:bg-white/10" href="#">
            <span class="text-sm">All Items</span>
            <span id="countAllMobile" class="text-xs text-slate-400">0</span>
          </a>
          <a class="flex items-center justify-between rounded-xl px-3 py-2 hover:bg-white/5" href="#">
            <span class="text-sm text-slate-200">Favorites</span>
            <span id="countFavMobile" class="text-xs text-slate-500">0</span>
          </a>
          <a class="flex items-center justify-between rounded-xl px-3 py-2 hover:bg-white/5" href="#">
            <span class="text-sm text-slate-200">Continue</span>
            <span id="countProgMobile" class="text-xs text-slate-500">0</span>
          </a>
        </div>

        <div class="mt-6 text-xs text-slate-500">
          Storage: <span class="text-slate-300">localStorage</span><br/>
          Import/Export: <span class="text-slate-300">JSON</span>
        </div>
      </div>
    </aside>


  <div class="mx-auto flex max-w-[1440px] gap-4 p-4 md:p-6">
    <!-- Desktop Sidebar -->
    <aside class="hidden md:block md:w-[280px] md:shrink-0">
      <div class="glass ring-soft rounded-2xl border border-white/5 p-4">
        <!-- Brand -->
        <div class="flex items-center gap-3">
          <div class="grid h-10 w-10 place-items-center rounded-xl bg-indigo-500/15 ring-soft">
            <span class="text-indigo-300 font-semibold">V</span>
          </div>
          <div>
            <div class="text-base font-semibold">Vault</div>
            <div class="text-xs text-slate-400">Personal Storage Library</div>
          </div>
        </div>
<!-- Quick actions -->
        <div class="mt-5 grid grid-cols-2 gap-2">
          <button id="btnAdd"
            class="rounded-xl bg-indigo-500/15 px-3 py-2 text-sm font-medium text-indigo-200 ring-soft hover:bg-indigo-500/20">
            + Add
          </button>
          <button id="btnImport"
            class="rounded-xl bg-white/5 px-3 py-2 text-sm font-medium text-slate-200 ring-soft hover:bg-white/10">
            Import
          </button>
        </div>

        <div class="mt-2 grid grid-cols-2 gap-2">
          <button id="btnExport"
            class="rounded-xl bg-white/5 px-3 py-2 text-sm font-medium text-slate-200 ring-soft hover:bg-white/10">
            Export
          </button>
          <button id="btnReset"
            class="rounded-xl bg-rose-500/15 px-3 py-2 text-sm font-medium text-rose-200 ring-soft hover:bg-rose-500/20">
            Reset
          </button>
        </div>

        <!-- Nav (UI only for now) -->
        <div class="mt-6 space-y-1">
          <div class="text-xs font-semibold text-slate-400">LIBRARY</div>
          <a class="flex items-center justify-between rounded-xl bg-white/5 px-3 py-2 ring-soft hover:bg-white/10" href="#">
            <span class="text-sm">All Items</span>
            <span id="countAll" class="text-xs text-slate-400">0</span>
          </a>
          <a class="flex items-center justify-between rounded-xl px-3 py-2 hover:bg-white/5" href="#">
            <span class="text-sm text-slate-200">Favorites</span>
            <span id="countFav" class="text-xs text-slate-500">0</span>
          </a>
          <a class="flex items-center justify-between rounded-xl px-3 py-2 hover:bg-white/5" href="#">
            <span class="text-sm text-slate-200">Continue</span>
            <span id="countProg" class="text-xs text-slate-500">0</span>
          </a>
        </div>

        <div class="mt-6 text-xs text-slate-500">
          Storage: <span class="text-slate-300">localStorage</span><br/>
          Import/Export: <span class="text-slate-300">JSON</span>
        </div>
      </div>
    </aside>


    <!-- Main -->
    <main class="flex-1 space-y-4">
      <!-- Top bar -->
      <header class="glass ring-soft rounded-2xl border border-white/5 p-4">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <div class="text-lg font-semibold">Your Library</div>
            <div class="text-xs text-slate-400">Track, store, and organize everything you watch & read.</div>
          </div>

          <div class="flex min-w-0 flex-1 gap-2 md:max-w-[680px] md:justify-end">
            <!-- Search -->
            <div class="relative w-full">
              <div class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 21l-4.3-4.3" />
                  <circle cx="11" cy="11" r="7" />
                </svg>
              </div>
              <input id="searchInput"
                class="w-full rounded-2xl bg-white/5 py-2.5 pl-10 pr-3 text-sm text-slate-100 placeholder:text-slate-500 ring-soft outline-none focus:bg-white/10"
                placeholder="Search title, tags, notes..."
              />
            </div>
          </div>
        </div>
          <div class="mt-3 flex flex-wrap items-center gap-2">
            <select id="filterType"
              class="rounded-2xl select-ui px-3 py-2 text-xs ring-soft hover:bg-white/10">
              <option value="">All Types</option>
            </select>

            <select id="filterStatus"
              class="rounded-2xl select-ui px-3 py-2 text-xs ring-soft hover:bg-white/10">
              <option value="">All Status</option>
              <option>Reading</option>
              <option>Watching</option>
              <option>Completed</option>
              <option>On Hold</option>
            </select>

            <button id="filterFav"
              class="rounded-2xl bg-white/5 px-3 py-2 text-xs text-slate-200 ring-soft hover:bg-white/10"
              aria-pressed="false" title="Show favorites only">
              â˜… Favorites
            </button>

            <select id="sortBy"
              class="rounded-2xl select-ui px-3 py-2 text-xs ring-soft hover:bg-white/10">
              <option value="addedDesc">Sort: Newest</option>
              <option value="addedAsc">Sort: Oldest</option>
              <option value="titleAsc">Sort: Title A â†’ Z</option>
              <option value="titleDesc">Sort: Title Z â†’ A</option>
              <option value="ratingDesc">Sort: Rating High</option>
              <option value="ratingAsc">Sort: Rating Low</option>
            </select>

            <button id="btnClearFilters"
              class="rounded-2xl bg-white/5 px-3 py-2 text-xs text-slate-200 ring-soft hover:bg-white/10">
              Clear
            </button>
          </div>

          <div class="mt-3 hidden lg:flex items-center justify-between gap-2">
            <div class="text-xs text-slate-400">
              Page <span id="pageInfo" class="text-slate-200">1</span>
            </div>

            <div class="flex items-center gap-2">
              <label class="text-xs text-slate-400">Per page</label>
              <select id="pageSize" class="rounded-2xl select-ui px-3 py-2 text-xs ring-soft hover:bg-white/10">
                <option value="10">10</option>
                <option value="12" selected>12</option>
                <option value="15">15</option>
                <option value="20">20</option>
              </select>

              <button id="btnPrevPage"
                class="rounded-2xl bg-white/5 px-3 py-2 text-xs text-slate-200 ring-soft hover:bg-white/10">
                Prev
              </button>
              <button id="btnNextPage"
                class="rounded-2xl bg-white/5 px-3 py-2 text-xs text-slate-200 ring-soft hover:bg-white/10">
                Next
              </button>
            </div>
          </div>

      </header>

      <!-- Stats row -->
      <section class="grid gap-3 md:grid-cols-4">
        <div class="glass ring-soft rounded-2xl border border-white/5 p-4">
          <div class="text-xs text-slate-400">Items</div>
          <div id="statItems" class="mt-1 text-2xl font-semibold">0</div>
          <div class="mt-2 text-xs text-slate-500">Stored locally</div>
        </div>
        <div class="glass ring-soft rounded-2xl border border-white/5 p-4">
          <div class="text-xs text-slate-400">In Progress</div>
          <div id="statProgress" class="mt-1 text-2xl font-semibold">0</div>
          <div class="mt-2 text-xs text-slate-500">Watching / Reading</div>
        </div>
        <div class="glass ring-soft rounded-2xl border border-white/5 p-4">
          <div class="text-xs text-slate-400">Favorites</div>
          <div id="statFav" class="mt-1 text-2xl font-semibold">0</div>
          <div class="mt-2 text-xs text-slate-500">Starred items</div>
        </div>
        <div class="glass ring-soft rounded-2xl border border-white/5 p-4">
          <div class="text-xs text-slate-400">Completed</div>
          <div id="statCompleted" class="mt-1 text-2xl font-semibold">0</div>
          <div class="mt-2 text-xs text-slate-500">Done</div>
        </div>
      </section>

      <!-- Content split -->
      <section class="grid gap-4 lg:grid-cols-[1fr_360px]">
        <!-- Cards grid -->
        <div class="glass ring-soft rounded-2xl border border-white/5 p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold">Recently Added</div>
              <div id="subHint" class="text-xs text-slate-400">Click an item to see details</div>
            </div>
            <div class="text-xs text-slate-500" id="hint"></div>
          </div>

          <!-- List / grid container -->
          <div id="cards"
            class="mt-4 grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-2 xl:grid-cols-3">
          </div>

          <!-- Pagination (bottom, desktop) -->
          <div class="mt-4 hidden lg:flex items-center justify-between gap-2">
            <div class="text-xs text-slate-400">
              Page <span id="pageInfoBottom" class="text-slate-200">1</span>
            </div>

            <div class="flex items-center gap-2">
              <button id="btnPrevPageBottom"
                class="rounded-2xl bg-white/5 px-3 py-2 text-xs text-slate-200 ring-soft hover:bg-white/10">
                Prev
              </button>
              <button id="btnNextPageBottom"
                class="rounded-2xl bg-white/5 px-3 py-2 text-xs text-slate-200 ring-soft hover:bg-white/10">
                Next
              </button>
            </div>
          </div>

        </div>

        <!-- Details panel -->
        <aside class="glass ring-soft rounded-2xl border border-white/5 p-4
          fixed inset-x-0 bottom-0 z-50 hidden max-h-[85vh] overflow-y-auto
          rounded-t-3xl border-t border-white/10
          peer-checked/details:block
          lg:static lg:block lg:max-h-none lg:rounded-2xl lg:border lg:border-white/5">
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="text-sm font-semibold">Details</div>
              <div class="text-xs text-slate-400">Selected item preview</div>
            </div>

            <div class="flex items-center gap-2">
              <label for="detailsToggle"
                class="cursor-pointer rounded-xl bg-white/5 px-3 py-2 text-xs text-slate-200 ring-soft hover:bg-white/10 lg:hidden">
                Close
              </label>

              <button id="btnEdit"
                class="rounded-xl bg-white/5 px-3 py-2 text-xs text-slate-200 ring-soft hover:bg-white/10">
                Edit
              </button>
              <button id="btnDelete"
                class="rounded-xl bg-rose-500/15 px-3 py-2 text-xs text-rose-200 ring-soft hover:bg-rose-500/20">
                Delete
              </button>
            </div>
          </div>

          <div class="mt-4 rounded-2xl bg-white/5 p-4 ring-soft" id="detailsCard">
            <div class="text-sm text-slate-400">No item selected.</div>
          </div>
        </aside>
      </section>

      <!-- Footer -->
      <footer class="pb-6 pt-2 text-center text-xs text-slate-500">
        Single-file app â€¢ localStorage + JSON Import/Export
      </footer>
    </main>
  </div>


  <!-- Add/Edit Modal -->
  <div id="modalBackdrop" class="fixed inset-0 z-[60] hidden bg-black/70"></div>

  <div id="itemModal" class="fixed inset-0 z-[70] hidden items-end justify-center p-4 sm:items-center">
    <div class="glass ring-soft w-full max-w-[720px] rounded-3xl border border-white/10 p-4 sm:p-6 max-h-[85vh] overflow-hidden flex flex-col">
      <div class="flex items-start justify-between gap-3 sticky top-0 z-10 -mx-4 sm:-mx-6 px-4 sm:px-6 py-3 bg-slate-900/40 backdrop-blur border-b border-white/10 rounded-t-3xl">
        <div class="min-w-0">
          <div id="modalTitle" class="text-base font-semibold">Edit item</div>
          <div class="text-xs text-slate-400">Update the fields then save.</div>
        </div>
        <button id="btnModalClose"
          class="rounded-xl bg-white/5 px-3 py-2 text-xs text-slate-200 ring-soft hover:bg-white/10">
          Close
        </button>
      </div>

      <form id="itemForm" class="mt-3 grid gap-3 flex-1 overflow-y-auto pr-1 hide-scrollbar">
        <div class="grid gap-3 sm:grid-cols-2">
          <div>
            <label class="text-xs text-slate-400">Title</label>
            <input id="fTitle" required
              class="mt-1 w-full rounded-2xl select-ui px-3 py-2 text-sm ring-soft"
              placeholder="Name of the series / manga / movie" />
          </div>

          <div>
            <label class="text-xs text-slate-400">Type</label>
            <select id="fType"
              class="mt-1 w-full rounded-2xl select-ui px-3 py-2 text-sm ring-soft">
              <option>Manga</option>
              <option>Manhwa</option>
              <option>Manhua</option>
              <option>Anime</option>
              <option>Series</option>
              <option>Drama</option>
              <option>Movie</option>
              <option value="">Other / Custom</option>
            </select>
            <input id="fTypeCustom"
              class="mt-2 hidden w-full rounded-2xl bg-white/5 px-3 py-2 text-sm text-slate-100 ring-soft outline-none focus:bg-white/10"
              placeholder="Custom type (optional)" />
          </div>
        </div>

        <div class="grid gap-3 sm:grid-cols-3">
          <div>
            <label class="text-xs text-slate-400">Status</label>
            <select id="fStatus"
              class="mt-1 w-full rounded-2xl select-ui px-3 py-2 text-sm ring-soft">
              <option>Reading</option>
              <option>Watching</option>
              <option>Completed</option>
              <option>On Hold</option>
            </select>
          </div>

          <div>
            <label class="text-xs text-slate-400">Emoji</label>
            <input id="fEmoji"
              class="mt-1 w-full rounded-2xl select-ui px-3 py-2 text-sm ring-soft"
              placeholder="ðŸ˜ ðŸ¥° ðŸ”¥ (optional)" />
          </div>

          <div>
            <label class="text-xs text-slate-400">Added date</label>
            <input id="fAdded" type="date"
              class="mt-1 w-full rounded-2xl select-ui px-3 py-2 text-sm ring-soft" />
          </div>
        </div>

        <div class="grid gap-3 sm:grid-cols-3">
          <div>
            <label class="text-xs text-slate-400">Progress unit</label>
            <select id="fUnit"
              class="mt-1 w-full rounded-2xl select-ui px-3 py-2 text-sm ring-soft">
              <option value="CH">CH (Chapter)</option>
              <option value="CP">CP (Chapter)</option>
              <option value="EP">EP (Episode)</option>
            </select>
          </div>

          <div>
            <label class="text-xs text-slate-400">Current</label>
            <input id="fCurrent" inputmode="numeric"
              class="mt-1 w-full rounded-2xl select-ui px-3 py-2 text-sm ring-soft"
              placeholder="302" />
          </div>

          <div>
            <label class="text-xs text-slate-400">Total (optional)</label>
            <input id="fTotal" inputmode="numeric"
              class="mt-1 w-full rounded-2xl select-ui px-3 py-2 text-sm ring-soft"
              placeholder="500" />
          </div>
        </div>

        <div class="grid gap-3 sm:grid-cols-2">
          <div>
            <label class="text-xs text-slate-400">Source</label>
            <input id="fSource"
              class="mt-1 w-full rounded-2xl select-ui px-3 py-2 text-sm ring-soft"
              placeholder="readrealm / Netflix / N/A" />
          </div>

          <div>
            <label class="text-xs text-slate-400">Rating (0â€“10, optional)</label>
            <input id="fRating" inputmode="decimal"
              class="mt-1 w-full rounded-2xl select-ui px-3 py-2 text-sm ring-soft"
              placeholder="8.5" />
          </div>
        </div>


        <div class="grid gap-3 sm:grid-cols-2">
          <div>
            <label class="text-xs text-slate-400">Image URL (optional)</label>
            <input id="fImageUrl"
              class="mt-1 w-full rounded-2xl bg-white/5 px-3 py-2 text-sm text-slate-100 ring-soft outline-none focus:bg-white/10"
              placeholder="https://...jpg / png / webp" />
          </div>

          <div class="rounded-2xl bg-black/20 p-4 ring-soft">
            <div class="text-xs text-slate-400">Tip</div>
            <div class="mt-1 text-xs text-slate-300">Paste a cover/poster URL to show an image on cards & details.</div>
          </div>
        </div>

        <div>
          <label class="text-xs text-slate-400">Tags (comma separated)</label>
          <input id="fTags"
            class="mt-1 w-full rounded-2xl select-ui px-3 py-2 text-sm ring-soft"
            placeholder="Fantasy, Action, Comedy" />
        </div>

        <div>
          <label class="text-xs text-slate-400">Notes</label>
          <textarea id="fNotes" rows="4"
            class="mt-1 w-full resize-none rounded-2xl bg-white/5 px-3 py-2 text-sm text-slate-100 ring-soft outline-none focus:bg-white/10"
            placeholder="Anything you want to remember..."></textarea>
        </div>

        <div class="flex flex-wrap items-center justify-between gap-3 pt-3 sticky bottom-0 bg-slate-950/40 backdrop-blur -mx-4 sm:-mx-6 px-4 sm:px-6 py-3 border-t border-white/10 rounded-b-3xl">
          <label class="inline-flex cursor-pointer items-center gap-2 text-sm text-slate-200">
            <input id="fFavorite" type="checkbox" class="h-4 w-4 rounded border-white/20 bg-white/10" />
            Favorite
          </label>

          <div class="flex gap-2">
            <button type="button" id="btnModalCancel"
              class="rounded-xl bg-white/5 px-4 py-2 text-sm text-slate-200 ring-soft hover:bg-white/10">
              Cancel
            </button>
            <button type="submit" id="btnModalSave"
              class="rounded-xl bg-indigo-500/20 px-4 py-2 text-sm font-medium text-indigo-100 ring-soft hover:bg-indigo-500/25">
              Save
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // =========================
    // Storage + Data Model
    // =========================
    const STORAGE_KEY = "vault.items.v1";

    /** Item shape (simple + flexible):
     * {
     *   id: string,
     *   title: string,
     *   type: "Movie"|"Drama"|"Series"|"Manga"|"Manhwa"|"Manhua"|string,
     *   status: "Watching"|"Reading"|"Completed"|"On Hold"|string,
     *   progress: { current?: number|null, total?: number|null, unit?: "EP"|"CH"|"CP"|string },
     *   rating?: number|null,            // 0..10
     *   tags?: string[],
     *   emoji?: string,
     *   source?: string,
     *   imageUrl?: string,
     *   added?: string,                 // YYYY-MM-DD
     *   notes?: string,
     *   favorite?: boolean
     * }
     */

    const sampleItems = [];

    function loadItems() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return null;
        return parsed;
      } catch {
        return null;
      }
    }

    function saveItems(items) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    function ensureSeed() {
      const existing = loadItems();
      if (Array.isArray(existing)) return existing;
      saveItems([]);
      return [];
    }

    // =========================
    // UI Helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    const els = {
      cards: $("cards"),
      hint: $("hint"),
      subHint: $("subHint"),
      searchInput: $("searchInput"),
      filterType: $("filterType"),
      filterStatus: $("filterStatus"),
      filterFav: $("filterFav"),
      sortBy: $("sortBy"),
      btnClearFilters: $("btnClearFilters"),
      pageInfo: $("pageInfo"),
      pageSize: $("pageSize"),
      btnPrevPage: $("btnPrevPage"),
      btnNextPage: $("btnNextPage"),
      modalBackdrop: $("modalBackdrop"),
      itemModal: $("itemModal"),
      modalTitle: $("modalTitle"),
      btnModalClose: $("btnModalClose"),
      btnModalCancel: $("btnModalCancel"),
      itemForm: $("itemForm"),
      fTitle: $("fTitle"),
      fType: $("fType"),
      fTypeCustom: $("fTypeCustom"),
      fStatus: $("fStatus"),
      fEmoji: $("fEmoji"),
      fAdded: $("fAdded"),
      fUnit: $("fUnit"),
      fCurrent: $("fCurrent"),
      fTotal: $("fTotal"),
      fSource: $("fSource"),
      fRating: $("fRating"),
      fImageUrl: $("fImageUrl"),
      fTags: $("fTags"),
      fNotes: $("fNotes"),
      fFavorite: $("fFavorite"),
      detailsCard: $("detailsCard"),
      detailsToggle: $("detailsToggle"),
      importFile: $("importFile"),

      // counters
      statItems: $("statItems"),
      statProgress: $("statProgress"),
      statFav: $("statFav"),
      statCompleted: $("statCompleted"),
      countAll: $("countAll"),
      countFav: $("countFav"),
      countProg: $("countProg"),

      // buttons
      btnAdd: $("btnAdd"),
      btnImport: $("btnImport"),
      btnExport: $("btnExport"),
      btnReset: $("btnReset"),
      btnEdit: $("btnEdit"),
      btnDelete: $("btnDelete"),
    };

    let items = ensureSeed();
    let selectedId = null;

    // Pagination (desktop only)
    let currentPage = 1;
    let perPage = 12; // default

    function fmtDate(yyyy_mm_dd) {
      if (!yyyy_mm_dd) return "N/A";
      const d = new Date(yyyy_mm_dd + "T00:00:00");
      if (Number.isNaN(d.getTime())) return yyyy_mm_dd;
      return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
    }

    function clampRating(r) {
      if (r === null || r === undefined || r === "") return null;
      const n = Number(r);
      if (Number.isNaN(n)) return null;
      return Math.max(0, Math.min(10, n));
    }

    function ratingPct(r) {
      const n = clampRating(r);
      if (n === null) return 0;
      return Math.round(n * 10);
    }

    function progressPct(p) {
      if (!p || p.current == null || p.total == null) return null;
      const cur = Number(p.current), tot = Number(p.total);
      if (!tot || Number.isNaN(cur) || Number.isNaN(tot)) return null;
      return Math.max(0, Math.min(100, Math.round((cur / tot) * 100)));
    }

    function matchesQuery(item, q) {
      if (!q) return true;
      const hay = [
        item.title,
        item.type,
        item.status,
        item.emoji,
        item.source,
        item.notes,
        ...(item.tags || [])
      ].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(q);
    }

    
    function getAllTypes(list) {
      const set = new Set(list.map(x => (x.type || "").trim()).filter(Boolean));
      return Array.from(set).sort((a,b) => a.localeCompare(b));
    }

    function parseDateOr0(s) {
      if (!s) return 0;
      const t = new Date(s + "T00:00:00").getTime();
      return Number.isNaN(t) ? 0 : t;
    }

    function applyFiltersAndSort(list) {
      const q = (els.searchInput.value || "").trim().toLowerCase();
      const type = (els.filterType.value || "").trim();
      const status = (els.filterStatus.value || "").trim();
      const favOnly = els.filterFav.getAttribute("aria-pressed") === "true";
      const sort = els.sortBy.value || "addedDesc";

      let out = list.filter(it => matchesQuery(it, q));
      if (type) out = out.filter(it => (it.type || "") === type);
      if (status) out = out.filter(it => (it.status || "") === status);
      if (favOnly) out = out.filter(it => !!it.favorite);

      // sort
      out = [...out].sort((a,b) => {
        if (sort === "titleAsc") return String(a.title||"").localeCompare(String(b.title||""));
        if (sort === "titleDesc") return String(b.title||"").localeCompare(String(a.title||""));
        if (sort === "ratingDesc") return (clampRating(b.rating) ?? -1) - (clampRating(a.rating) ?? -1);
        if (sort === "ratingAsc") return (clampRating(a.rating) ?? 999) - (clampRating(b.rating) ?? 999);
        if (sort === "addedAsc") return parseDateOr0(a.added) - parseDateOr0(b.added);
        // default newest
        return parseDateOr0(b.added) - parseDateOr0(a.added);
      });

      return out;
    }

    function refreshTypeOptions() {
      const types = getAllTypes(items);
      const current = els.filterType.value || "";
      els.filterType.innerHTML = `<option value="">All Types</option>` +
        types.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
      // keep selection if still exists
      if (types.includes(current)) els.filterType.value = current;
    }

    // =========================
    // Render
    // =========================
    function renderStats(list) {
      const total = list.length;
      const fav = list.filter(x => !!x.favorite).length;
      const inProg = list.filter(x => ["Watching","Reading"].includes(x.status)).length;
      const done = list.filter(x => x.status === "Completed").length;

      els.statItems.textContent = total;
      els.statFav.textContent = fav;
      els.statProgress.textContent = inProg;
      els.statCompleted.textContent = done;

      els.countAll.textContent = total.toLocaleString();
      els.countFav.textContent = fav.toLocaleString();
      els.countProg.textContent = inProg.toLocaleString();

      const cAllM = document.getElementById("countAllMobile");
      const cFavM = document.getElementById("countFavMobile");
      const cProgM = document.getElementById("countProgMobile");
      if (cAllM) cAllM.textContent = total.toLocaleString();
      if (cFavM) cFavM.textContent = fav.toLocaleString();
      if (cProgM) cProgM.textContent = inProg.toLocaleString();
    }

    function cardHTML(item) {
      const r = clampRating(item.rating);
      const pct = ratingPct(r);
      const typePill = `
        <span class="rounded-full bg-indigo-500/15 px-2 py-0.5 text-[11px] text-indigo-200 ring-soft">${escapeHtml(item.type || "N/A")}</span>
      `;
      const statusPill = `
        <span class="rounded-full bg-emerald-500/15 px-2 py-0.5 text-[11px] text-emerald-200 ring-soft">${escapeHtml(item.status || "N/A")}</span>
      `;
      const tags = (item.tags || []).slice(0, 3).map(t =>
        `<span class="rounded-full bg-white/5 px-2 py-0.5 text-[11px] text-slate-300 ring-soft">${escapeHtml(t)}</span>`
      ).join("");

      const prog = item.progress || {};
      const unit = prog.unit || "EP";
      const progText = (prog.current != null) ? `${unit} ${prog.current}${(prog.total != null ? " / " + prog.total : "")}` : "N/A";

      const favStar = item.favorite ? "â˜…" : "â˜†";
      const favClass = item.favorite ? "bg-amber-500/15 text-amber-200 hover:bg-amber-500/20" : "bg-white/5 text-slate-200 hover:bg-white/10";

      return `
        <article class="group relative overflow-hidden rounded-2xl bg-white/5 ring-soft hover:bg-white/10">
          <!-- Mobile tap area -->
          <button data-id="${item.id}" class="w-full text-left p-0 lg:hidden">
            <div class="overflow-hidden rounded-xl ring-soft bg-white/5">
              <div class="h-28 w-full bg-black/20">
                <div class="h-full w-full bg-cover bg-center" style="background-image:url('${escapeAttr(item.imageUrl || "")}');"></div>
              </div>

              <div class="p-2">
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0">
                    <div class="truncate text-xs font-semibold">${escapeHtml(item.title || "Untitled")}</div>
                    <div class="mt-0.5 text-[10px] text-slate-400">${escapeHtml(item.type || "N/A")} â€¢ ${escapeHtml(item.status || "N/A")}</div>
                  </div>
                  <div class="shrink-0 rounded-full bg-black/30 px-2 py-0.5 text-[11px] text-slate-200 ring-soft">
                    ${r == null ? "â€”" : `â˜… ${r.toFixed(1)}`}
                  </div>
                </div>

                <div class="mt-1 text-[10px] text-slate-400">${escapeHtml(progText)}</div>

                <div class="mt-1 flex flex-wrap gap-1">${tags || ""}</div>

                <div class="mt-2 flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    ${typePill}
                    ${statusPill}
                    <span class="text-[11px] text-slate-400">${escapeHtml(item.emoji || "")}</span>
                  </div>
                  <span class="text-[10px] text-slate-500">Edit</span>
                </div>
              </div>
            </div>
          </button>

          <!-- Desktop card -->
          <div class="hidden lg:block p-3">
            <div class="flex gap-3">
              <div class="h-28 w-20 overflow-hidden rounded-xl ring-soft bg-black/20 transition-transform duration-200 group-hover:scale-[1.03]">
                <div class="h-full w-full bg-cover bg-center" style="background-image:url('${escapeAttr(item.imageUrl || "")}');"></div>
              </div>

              <div class="min-w-0 flex-1">
                <div class="flex items-start justify-between gap-2">
                  <button data-id="${item.id}" class="truncate text-sm font-semibold hover:underline">
                    ${escapeHtml(item.title || "Untitled")}
                  </button>
                  ${typePill}
                </div>

                <div class="mt-1 text-xs text-slate-400">${escapeHtml(item.status || "N/A")} â€¢ ${escapeHtml(progText)} â€¢ ${escapeHtml(item.source || "N/A")}</div>
                <div class="mt-2 flex flex-wrap gap-1">${tags || ""}</div>
              </div>
            </div>

            <div class="mt-3 flex items-center justify-between">
              <div class="text-xs text-slate-400">Rating</div>
              <div class="text-xs text-slate-300">${r == null ? "Not rated" : `${r.toFixed(1)} / 10`}</div>
            </div>

            <div class="mt-2 h-2 w-full rounded-full bg-black/30">
              <div class="h-2 rounded-full bg-amber-400/70" style="width:${pct}%"></div>
            </div>

            <div class="mt-3 flex gap-2 opacity-90">
              <button data-id="${item.id}" class="btn-open flex-1 rounded-xl bg-indigo-500/15 px-3 py-2 text-xs font-medium text-indigo-200 ring-soft hover:bg-indigo-500/20">
                Open
              </button>
              <button data-star="${item.id}" class="rounded-xl px-3 py-2 text-xs ring-soft ${favClass}" title="Toggle favorite">
                ${favStar}
              </button>
            </div>
          </div>
        </article>
      `;
    }

    function escapeAttr(str) {
      // safe for single-quoted attribute usage
      return String(str ?? "").replace(/'/g, "%27").replace(/\n/g, " ");
    }

    function escapeHtml(str) {
      return String(str ?? "").replace(/[&<>"']/g, (m) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }

    function render() {
      refreshTypeOptions();
      const filtered = applyFiltersAndSort(items);
      renderStats(items);

      const isMobileNow = window.matchMedia("(max-width: 1023px)").matches;
      if (els.subHint) els.subHint.textContent = isMobileNow ? "Tap an item to edit" : "Click an item to see details";

      els.hint.textContent = filtered.length === items.length
        ? `${items.length} items`
        : `${filtered.length} / ${items.length}`;

      const isDesktopList = window.matchMedia("(min-width: 1024px)").matches; // lg+
      // paginate only on desktop
      let pageCount = 1;
      let pageItems = filtered;
      if (isDesktopList) {
        pageCount = Math.max(1, Math.ceil(filtered.length / perPage));
        currentPage = Math.min(Math.max(1, currentPage), pageCount);
        const start = (currentPage - 1) * perPage;
        pageItems = filtered.slice(start, start + perPage);
      }

      els.cards.innerHTML = pageItems.map(cardHTML).join("");

      // update pagination UI
      if (els.pageInfo) {
        if (isDesktopList) els.pageInfo.textContent = `${currentPage} / ${pageCount}`;
        else els.pageInfo.textContent = "1 / 1";
      }
      if (els.btnPrevPage) els.btnPrevPage.disabled = !isDesktopList || currentPage <= 1;
      if (els.btnNextPage) els.btnNextPage.disabled = !isDesktopList || currentPage >= pageCount;

      const pageInfoBottom = document.getElementById("pageInfoBottom");
      const btnPrevBottom = document.getElementById("btnPrevPageBottom");
      const btnNextBottom = document.getElementById("btnNextPageBottom");
      if (pageInfoBottom) pageInfoBottom.textContent = isDesktopList ? `${currentPage} / ${pageCount}` : "1 / 1";
      if (btnPrevBottom) btnPrevBottom.disabled = !isDesktopList || currentPage <= 1;
      if (btnNextBottom) btnNextBottom.disabled = !isDesktopList || currentPage >= pageCount;

      // attach handlers
      els.cards.querySelectorAll("[data-id]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const item = items.find(x => x.id === id);
          if (!item) return;
          const isMobile = window.matchMedia("(max-width: 1023px)").matches; // < lg
          if (isMobile) openModal("edit", item);
          else openDetails(id);
        });
      });
      els.cards.querySelectorAll("[data-star]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          toggleFavorite(btn.getAttribute("data-star"));
        });
      });
      els.cards.querySelectorAll(".btn-open").forEach(btn => {
        btn.addEventListener("click", () => openDetails(btn.getAttribute("data-id")));
      });

      // keep details visible after rerender
      if (selectedId) {
        const still = items.find(x => x.id === selectedId);
        if (still) renderDetails(still);
        else clearDetails();
      }
    }

    // =========================
    // Details Panel
    // =========================
    function clearDetails() {
      selectedId = null;
      els.detailsCard.innerHTML = `<div class="text-sm text-slate-400">No item selected.</div>`;
    }

    function openDetails(id) {
      const item = items.find(x => x.id === id);
      if (!item) return;
      selectedId = id;
      renderDetails(item);

      // open mobile sheet
      els.detailsToggle.checked = true;
    }

    function renderDetails(item) {
      const prog = item.progress || {};
      const unit = prog.unit || "EP";
      const progText = (prog.current != null)
        ? `${unit} ${prog.current}${(prog.total != null ? " / " + prog.total : "")}`
        : "N/A";

      const pPct = progressPct(prog);
      const r = clampRating(item.rating);
      const rPct = ratingPct(r);

      const tags = (item.tags || []).map(t =>
        `<span class="rounded-full bg-white/5 px-2 py-0.5 text-[11px] text-slate-300 ring-soft">${escapeHtml(t)}</span>`
      ).join("") || `<span class="text-xs text-slate-400">No tags</span>`;

      const favoritePill = item.favorite
        ? `<span class="rounded-full bg-amber-500/15 px-2 py-0.5 text-[11px] text-amber-200 ring-soft">Favorite</span>`
        : ``;

      els.detailsCard.innerHTML = `
        <div class="flex gap-3">
          <div class="h-28 w-20 shrink-0 overflow-hidden rounded-xl ring-soft bg-black/20">
            <div class="h-full w-full bg-cover bg-center" style="background-image:url('${escapeAttr(item.imageUrl || "")}');"></div>
          </div>

          <div class="min-w-0 flex-1">
            <div class="truncate text-base font-semibold">${escapeHtml(item.title || "Untitled")}</div>
            <div class="mt-1 text-xs text-slate-400">${escapeHtml(item.type || "N/A")} â€¢ Added ${escapeHtml(fmtDate(item.added))}</div>

            <div class="mt-3 flex flex-wrap items-center gap-2">
              <span class="rounded-full bg-indigo-500/15 px-2 py-0.5 text-[11px] text-indigo-200 ring-soft">${escapeHtml(item.type || "N/A")}</span>
              <span class="rounded-full bg-emerald-500/15 px-2 py-0.5 text-[11px] text-emerald-200 ring-soft">${escapeHtml(item.status || "N/A")}</span>
              ${favoritePill}
              <span class="text-[11px] text-slate-300">${escapeHtml(item.emoji || "")}</span>
            </div>
          </div>
        </div>

        <div class="mt-4 grid gap-3 sm:grid-cols-2">
          <div class="rounded-2xl bg-black/20 p-4 ring-soft">
            <div class="flex items-start justify-between gap-2">
              <div>
                <div class="text-xs font-medium text-slate-200">Progress</div>
                <div class="mt-1 text-sm text-slate-100">${escapeHtml(progText)}</div>
              </div>
              <span class="rounded-full bg-white/5 px-2 py-1 text-[11px] text-slate-200 ring-soft">${escapeHtml(unit)}</span>
            </div>
            <div class="mt-3 h-2 w-full rounded-full bg-black/30">
              <div class="h-2 rounded-full bg-indigo-400/70" style="width:${pPct == null ? 0 : pPct}%"></div>
            </div>
            <div class="mt-2 text-[11px] text-slate-500">${pPct == null ? "Total is optional." : (pPct + "%")}</div>
          </div>

          <div class="rounded-2xl bg-black/20 p-4 ring-soft">
            <div class="flex items-start justify-between gap-2">
              <div>
                <div class="text-xs font-medium text-slate-200">Rating</div>
                <div class="mt-1 text-sm text-slate-100">${r == null ? "Not rated" : `â˜… ${r.toFixed(1)} / 10`}</div>
              </div>
              <span class="rounded-full bg-white/5 px-2 py-1 text-[11px] text-slate-200 ring-soft">Optional</span>
            </div>
            <div class="mt-3 h-2 w-full rounded-full bg-black/30">
              <div class="h-2 rounded-full bg-amber-400/70" style="width:${rPct}%"></div>
            </div>
            <div class="mt-2 text-[11px] text-slate-500">${r == null ? "Leave empty if you donâ€™t rate." : (rPct + "%")}</div>
          </div>
        </div>

        <div class="mt-4 grid gap-3">
          <div class="grid gap-2 sm:grid-cols-2">
            <div class="rounded-2xl bg-black/20 p-4 ring-soft">
              <div class="text-xs text-slate-400">Source</div>
              <div class="mt-1 text-sm text-slate-200">${escapeHtml(item.source || "N/A")}</div>
            </div>
            <div class="rounded-2xl bg-black/20 p-4 ring-soft">
              <div class="text-xs text-slate-400">Tags</div>
              <div class="mt-2 flex flex-wrap gap-1">${tags}</div>
            </div>
          </div>

          <div class="rounded-2xl bg-black/20 p-4 ring-soft">
            <div class="text-xs text-slate-400">Notes</div>
            <p class="mt-2 text-sm text-slate-200 leading-relaxed whitespace-pre-wrap">
              ${escapeHtml(item.notes || "â€”")}
            </p>
          </div>
        </div>
      `;
    }

    // =========================
    // Actions
    // =========================

    let modalMode = "add"; // "add" | "edit"
    let modalEditingId = null;

    function openModal(mode, item=null) {
      modalMode = mode;
      modalEditingId = item?.id || null;

      els.modalTitle.textContent = mode === "add" ? "Add item" : "Edit item";

      // fill defaults
      els.fTitle.value = item?.title || "";
      els.fStatus.value = item?.status || "Reading";
      els.fEmoji.value = item?.emoji || "";
      els.fAdded.value = item?.added || new Date().toISOString().slice(0,10);

      const type = item?.type || "Manga";
      // set type dropdown; if not in list, use custom
      const opts = Array.from(els.fType.options).map(o => o.value || o.textContent);
      if (opts.includes(type)) {
        els.fType.value = type;
        els.fTypeCustom.classList.add("hidden");
        els.fTypeCustom.value = "";
      } else {
        els.fType.value = "";
        els.fTypeCustom.classList.remove("hidden");
        els.fTypeCustom.value = type;
      }

      const prog = item?.progress || {};
      els.fUnit.value = prog.unit || "CH";
      els.fCurrent.value = (prog.current ?? "") === null ? "" : (prog.current ?? "");
      els.fTotal.value = (prog.total ?? "") === null ? "" : (prog.total ?? "");

      els.fSource.value = item?.source || "N/A";
      els.fRating.value = item?.rating ?? "";
      els.fImageUrl.value = item?.imageUrl || "";
      els.fTags.value = (item?.tags || []).join(", ");
      els.fNotes.value = item?.notes || "";
      els.fFavorite.checked = !!item?.favorite;

      showModal();
    }

    function showModal() {
      els.modalBackdrop.classList.remove("hidden");
      els.itemModal.classList.remove("hidden");
      els.itemModal.classList.add("flex");
      // focus title
      setTimeout(() => els.fTitle.focus(), 0);
    }

    function closeModal() {
      els.modalBackdrop.classList.add("hidden");
      els.itemModal.classList.add("hidden");
      els.itemModal.classList.remove("flex");
      modalEditingId = null;
    }
    function toggleFavorite(id) {
      const it = items.find(x => x.id === id);
      if (!it) return;
      it.favorite = !it.favorite;
      saveItems(items);
      setPage1AndRender();
    }

    function addQuick() {
      openModal("add");
    }

    function deleteSelected() {
      if (!selectedId) return alert("Select an item first.");
      const it = items.find(x => x.id === selectedId);
      if (!it) return;

      const ok = confirm(`Delete "${it.title}"?`);
      if (!ok) return;

      items = items.filter(x => x.id !== selectedId);
      saveItems(items);
      clearDetails();
      render();
    }

    function editSelected() {
      if (!selectedId) return alert("Select an item first.");
      const it = items.find(x => x.id === selectedId);
      if (!it) return;
      openModal("edit", it);
    }

    function exportJSON() {
      const data = JSON.stringify(items, null, 2);
      const blob = new Blob([data], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `vault-export-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    function importJSONFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(String(reader.result || "null"));
          if (!Array.isArray(parsed)) throw new Error("JSON must be an array of items.");
          // minimal validation + normalization
          const normalized = parsed.map(x => ({
            id: x.id || crypto.randomUUID(),
            title: x.title || "Untitled",
            type: x.type || "N/A",
            status: x.status || "N/A",
            progress: x.progress || { current: null, total: null, unit: "CH" },
            rating: (x.rating === undefined ? null : clampRating(x.rating)),
            tags: Array.isArray(x.tags) ? x.tags : [],
            emoji: x.emoji || "",
            source: x.source || "N/A",
            imageUrl: x.imageUrl || "",
            added: x.added || new Date().toISOString().slice(0,10),
            notes: x.notes || "",
            favorite: !!x.favorite
          }));
          items = normalized;
          saveItems(items);
          clearDetails();
          render();
          alert("Import successful!");
        } catch (e) {
          alert("Import failed: " + (e?.message || e));
        }
      };
      reader.readAsText(file);
    }

    function resetAll() {
      const ok = confirm("Reset will delete your local data and restore sample items. Continue?");
      if (!ok) return;
      items = [...sampleItems];
      saveItems(items);
      clearDetails();
      render();
    }

    // =========================
    // Wire up events
    // =========================
    function setPage1AndRender() { currentPage = 1; render(); }

    // filters/search/sort
    els.searchInput.addEventListener("input", setPage1AndRender);
    els.filterType.addEventListener("change", setPage1AndRender);
    els.filterStatus.addEventListener("change", setPage1AndRender);
    els.sortBy.addEventListener("change", setPage1AndRender);

    els.filterFav.addEventListener("click", () => {
      const on = els.filterFav.getAttribute("aria-pressed") === "true";
      els.filterFav.setAttribute("aria-pressed", String(!on));
      els.filterFav.classList.toggle("bg-amber-500/15", !on);
      els.filterFav.classList.toggle("text-amber-200", !on);
      setPage1AndRender();
    });

    els.btnClearFilters.addEventListener("click", () => {
      els.searchInput.value = "";
      els.filterType.value = "";
      els.filterStatus.value = "";
      els.sortBy.value = "addedDesc";
      els.filterFav.setAttribute("aria-pressed", "false");
      els.filterFav.classList.remove("bg-amber-500/15","text-amber-200");
      setPage1AndRender();
    });

    // Pagination controls (desktop)
    if (els.pageSize) {
      // init perPage from UI
      perPage = Number(els.pageSize.value) || perPage;
      els.pageSize.addEventListener("change", () => {
        perPage = Number(els.pageSize.value) || perPage;
        currentPage = 1;
        render();
      });
    }

    const pageNav = (delta) => {
      currentPage = Math.max(1, currentPage + delta);
      render();
    };

    if (els.btnPrevPage) els.btnPrevPage.addEventListener("click", () => pageNav(-1));
    if (els.btnNextPage) els.btnNextPage.addEventListener("click", () => pageNav(+1));

    // Bottom pagination (desktop)
    const btnPrevBottom = document.getElementById("btnPrevPageBottom");
    const btnNextBottom = document.getElementById("btnNextPageBottom");
    if (btnPrevBottom) btnPrevBottom.addEventListener("click", () => pageNav(-1));
    if (btnNextBottom) btnNextBottom.addEventListener("click", () => pageNav(+1));

    // Keep pagination state sane on resize (switching breakpoints)
    window.addEventListener("resize", () => { render(); });



    els.btnAdd.addEventListener("click", addQuick);
    const btnAddM = document.getElementById("btnAddMobile");
    if (btnAddM) btnAddM.addEventListener("click", addQuick);

    els.btnImport.addEventListener("click", () => els.importFile.click());
    const btnImportM = document.getElementById("btnImportMobile");
    if (btnImportM) btnImportM.addEventListener("click", () => els.importFile.click());
    els.importFile.addEventListener("change", () => {
      const f = els.importFile.files && els.importFile.files[0];
      els.importFile.value = "";
      if (!f) return;
      importJSONFile(f);
    });

    els.btnExport.addEventListener("click", exportJSON);
    const btnExportM = document.getElementById("btnExportMobile");
    if (btnExportM) btnExportM.addEventListener("click", exportJSON);
    els.btnReset.addEventListener("click", resetAll);
    const btnResetM = document.getElementById("btnResetMobile");
    if (btnResetM) btnResetM.addEventListener("click", resetAll);

    els.btnDelete.addEventListener("click", deleteSelected);
    els.btnEdit.addEventListener("click", editSelected);


    // Modal wiring
    els.fType.addEventListener("change", () => {
      if (els.fType.value === "") els.fTypeCustom.classList.remove("hidden");
      else { els.fTypeCustom.classList.add("hidden"); els.fTypeCustom.value = ""; }
    });

    function readNumberOrNull(v) {
      const s = String(v ?? "").trim();
      if (!s) return null;
      const n = Number(s);
      return Number.isNaN(n) ? null : n;
    }

    els.itemForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const title = String(els.fTitle.value || "").trim();
      if (!title) return;

      const type = (els.fType.value === "" ? String(els.fTypeCustom.value || "").trim() : String(els.fType.value).trim()) || "N/A";
      const status = String(els.fStatus.value || "N/A").trim();
      const emoji = String(els.fEmoji.value || "").trim();
      const added = els.fAdded.value || new Date().toISOString().slice(0,10);

      const unit = String(els.fUnit.value || "CH").trim();
      const current = readNumberOrNull(els.fCurrent.value);
      const total = readNumberOrNull(els.fTotal.value);

      const source = String(els.fSource.value || "N/A").trim() || "N/A";
      const imageUrl = String(els.fImageUrl.value || "").trim();
      const rating = clampRating(readNumberOrNull(els.fRating.value));
      const tags = String(els.fTags.value || "").split(",").map(s => s.trim()).filter(Boolean);
      const notes = String(els.fNotes.value || "").trim();
      const favorite = !!els.fFavorite.checked;

      if (modalMode === "add") {
        const item = {
          id: crypto.randomUUID(),
          title, type, status,
          progress: { current, total, unit },
          rating,
          tags,
          emoji,
          source,
          imageUrl,
          added,
          notes,
          favorite
        };
        items.unshift(item);
        saveItems(items);
        closeModal();
        render();
        openDetails(item.id);
        return;
      }

      // edit
      const it = items.find(x => x.id === modalEditingId);
      if (!it) {
        closeModal();
        return;
      }

      it.title = title;
      it.type = type;
      it.status = status;
      it.emoji = emoji;
      it.added = added;
      it.progress = { current, total, unit };
      it.source = source;
      it.imageUrl = imageUrl;
      it.rating = rating;
      it.tags = tags;
      it.notes = notes;
      it.favorite = favorite;

      saveItems(items);
      closeModal();
      render();
      renderDetails(it);
    });

    function modalCloseAll() { closeModal(); }

    els.btnModalClose.addEventListener("click", modalCloseAll);
    els.btnModalCancel.addEventListener("click", modalCloseAll);
    els.modalBackdrop.addEventListener("click", modalCloseAll);
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });


    // Initial paint
    render();
  </script>
  </div>
</body>
</html>
